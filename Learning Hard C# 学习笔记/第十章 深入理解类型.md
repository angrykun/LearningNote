## 第十章 深入理解类型 ##

### 10.1 C#中的类型 ###

C#中类型分两种：值类型，引用类型。

#### 10.1.1 什么是值类型和引用类型 ####

- 值类型主要包括：简单类型，枚举类型和结构体类型等。值类型的实例通常被分配在线程的堆栈上，变量保存的内容就是实例数据本身。

- 引用类型主要包括：类，接口，委托类型和字符串等。引用类型的实例则被分配在托管堆上，变量保存的是实例数据的内存地址。

#### 10.1.2 值类型和引用类型的区别 ####

值类型通常分配在线程堆栈上，值类型的管理有操作系统负责；而引用类型则被分配到托管堆上，引用类型的管理由垃圾回收器(GC)负责。

管理主要是指对内存空间的分配和释放。

       static void Main(string[] args)
        {
            //值类型
            int valueType = 3;
            //引用类型
            string reftype = "abc";
		}

程序中，每个变量都有其堆栈地址，并且不同变量的堆栈地址不同，所以上面两个变量占用了不同的位置。

![值类型引用类型](http://i.imgur.com/JVnNgSq.png)

不管是值类型还是引用类型，变量本身都是存储在**堆栈**上的。

值类型和引用类型的区别在于**实际数据的存储位置**：值类型的变量和实际数据都存储在堆栈上，而引用类型则只有变量存储在堆栈上，变量存储着实际数据的地址，实际数据存储在**与地址相对应的托管堆中**。

**PS：值类型不一定总是在堆栈上，当引用类型中潜逃值类型，或在值类型装箱的情况下，值类型的实例就会被分配到托管堆中。**

1. 引用类型中嵌套值类型

如果类的字段是值类型，它将作为引用类型实例一部分，被分配到托管堆中。但是局部变量仍然被分配到堆栈上。

		//引用类型嵌套定义值类型的情况
        public class NesteValueTypeInRef
        {
            // valuetype作为引用类型的一部分,分配到托管堆上
            private int valuetype = 3;

            public void method()
            {
                char c = 'c';
            }
        }

内存分配情况如下：

![内存分配](http://i.imgur.com/TRhK83K.png)


2. 值类型中嵌套引用类型

值类型嵌套定义引用类型时，堆栈上将保存该引用类型的引用，而实际数据依然存储在托管堆中。


        public class TestClass
        {
            public int x;
            public int y;
        }
        //引用类型嵌套定义值类型的情况
        public struct NesteRefTypeInValue
        {
            private TestClass classinValue;
            public NesteRefTypeInValue(TestClass t)
            {
                classinValue = t;
                classinValue.x = 1;
                classinValue.y = 5;
            } 
        }

 		//调用
		NesteRefTypeInValue valueType=new NesteRefTypeInValue(new TestClass());

内存分配情况如下图：

![内存分配](http://i.imgur.com/hhi9DBh.png)

值类型实例总会被分配到它声明的地方，声明的是局部变量时，将被分配到栈上，声明为引用类型成员时，被分配到托管堆上；引用类型实例总是被分配到托管堆上。

值类型引用类型的区别：

- 值类型继承自ValueType，ValutType又继承自System.Object；引用类型直接继承自System.Object。
- 值类型不受GC(垃圾回收器)控制，作用域结束时，值类型会被操作系统自行释放，从而减少托管堆的压力；引用类型的内存管理由GC完成。所以**值类型具有性能优势。**
- 若值类型是密封的(sealed),不可继承；引用类型则一般具有继承性。
- 值类型不能为null，默认初始化值为0；引用类型默认情况下初始化为null，表示不指向托管堆中的地址。
- 值类型变量包含的是实际数据，因此值类型之间的参数传递不会影响变量本身；引用类型保存的是地址的引用，作为参数传递时，参数会发生改变。

### 10.1.3 两大类型转换 ###
 
类型转换方式：
- 隐式类型转换：由低级别类型向高级别类型的转换过程。
- 显示类型转换：也叫强制类型转换。(type)(变量或函数)
- is 或as 安全类型转换
- NET中Convert类完成转换

装箱：将值类型转换为引用类型的过程。装箱过程中，系统会在托管堆中生成一根堆栈中值类型对象的副本。

拆箱：将引用类型转换为值类型的过程。拆箱过程中，从托管堆中将引用类型所指向的已装箱数据复制回值类型对象。

